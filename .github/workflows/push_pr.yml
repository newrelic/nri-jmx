name: Push/PR pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:

env:
  NRJMX_VERSION: '2.6.0' # TODO check if we should update it to latest release version

jobs:
  # reusable_push_pr contains static-analysis but it does not contain the Semgrep step
  # static-analysis job in reusable_push_pr cannot be disabled
  # uncommenting the below leads to the following error "creating validator: parsing markdown: parsing markdown headers: unexpected additional L1 header \"2.4.7 (2021-06-10)\" found, only a single L1 header is allowed"
  # TODO check if we can remove the below code and ignore the Semgrep step
  # static-analysis:
  #   name: Run all static analysis checks
  #   runs-on: ubuntu-20.04
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: newrelic/newrelic-infra-checkers@v1
  #     - name: Semgrep
  #       uses: returntocorp/semgrep-action@v1
  #       with:
  #         auditOn: push

  #     - name: Install Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version-file: 'go.mod'

  #     - name: golangci-lint
  #       uses: golangci/golangci-lint-action@v6
  #       continue-on-error: ${{ github.event_name != 'pull_request' }}
  #       with:
  #         only-new-issues: true

  # can't run this step inside of container because of tests specific
  test-integration-nix:
    name: Run integration tests on *Nix
    runs-on: ubuntu-20.04
    defaults:
      run:
        working-directory: src/github.com/${{env.ORIGINAL_REPO_NAME}}
    steps:
      - name: Check out code
        uses: actions/checkout@v2
        with:
          fetch-depth: 1
          path: src/github.com/${{env.ORIGINAL_REPO_NAME}}
      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'src/github.com/${{env.ORIGINAL_REPO_NAME}}/go.mod'
      - name: Integration test
        env:
          GOPATH: ${{ github.workspace }}
        run: make integration-test

  push-pr:
    uses: newrelic/coreint-automation/.github/workflows/reusable_push_pr.yaml@v3
    with:
      integration: jmx
      run_integration_nix: false
    secrets: inherit